<html>
<body>
<meta charset="utf-8">
<head>
<style>
</style>
</head>
<div id='map'></div>
<nav id="menu"></nav>
<div id='console'>
  <h1>New Construction Projects</h1>
  <div class ='session'>
    <h2>Deliveries Year 2000 thru:
      <label id='year'></label></h2>
      <input id='slider' class='row' type='range' min='1999' max='2024' step='1' value='1999'/>
  </div>
  <div class='session'>
    <h2>Property Type</h2>
    <div class='row' id='filters'>
      <input id='all' type='radio' name='toggle' value='all' checked='checked'>
      <label for='all'>All</label>
      <input id="Office" type="radio" name="toggle" value="Office">
      <label for='Office'>Office</label>
      <input id="Resi" type="radio" name="toggle" value="Resi">
      <label for='Resi'>Multifamily</label>
    </div>
  </div>
</div>
<!-- External JS libraries -->

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<!-- JS Code -->
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibXBvdHRlciIsImEiOiJjajAxZGltM3UwNjF2MzJsczVnN3R2eTNnIn0._Sj0HRLt8VTQGTojMWYFfQ';
var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mpotter/cjzbo5zbg1f2n1doce85e6838',
  center: [-87.636127, 41.892699],
  zoom: 13.5,
  attributionControl: false
});

map.on('load', function() {
var filterYear = ['<=',['number',['get','Year']], year];
var filterType = ['!=', ['string', ['get', 'Type']], 'placeholder'];

// Create a year Property value based on time used to filter against.
d3.json("/data/supply_to_date.geojson").then(function(data) {
  data.features = data.features.map(function(d) {
    d.properties.year = new Date(d.properties);
    return d;
});


map.addSource('resi', {
  'type': 'geojson',
  data: data,
});
map.addLayer({
  'id': 'residential-circles',
  'type': 'circle',
  'source': 'resi',
  'paint': {
    'circle-color': [
        'match',
        ['get', 'Type'],
        'Resi', '#fbb03b',
        'Office', '#0E9447',
        /*other*/ '#ccc'
        ],
    'circle-opacity': .75,
      'circle-radius': [
        'interpolate',
        ['linear'],
          ['number',['get', 'GFA']],
            50000, 10,
            1500000, 40
        ]
    },
  });
map.addLayer({
  'id': 'residential-labels',
  'type': 'symbol',
  'source': 'resi',
  'layout': {
    'text-field': ['to-string', ['get', 'Project']],
    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
    'text-size': [
        'interpolate',
        ['linear'],
        ['zoom'],
        4,12,
        6,16
    ],
    'text-max-width': 5
    },
  'paint': {
    'text-color': 'rgba(0,0,0,0.5)'
  },
  });

//NOTE: removed/refactored filterBy function to javascript, but kept ih 'existing' for reference

// Set filter to first year of the range
// 0 = 1999
filterBy(1999);
document.getElementById('slider').addEventListener('input', function(e) {
  var year = parseInt(e.target.value);

  // update the map
  filterYear = ['<=', ['number', ['get', 'Year']], year];
  map.setFilter('residential-circles', ['all', filterYear, filterType]);
  map.setFilter('residential-labels', ['all', filterYear, filterType]);

// update text in the UI
document.getElementById('year').innerText = year;
});
// radio buttons for filtering
document.getElementById('filters').addEventListener('change', function(e) {
  var type = e.target.value;
  // update the map filter
  if (type === 'all') {
    filterType = ['!=', ['string', ['get', 'Type']], 'placeholder'];
  } else if (type === 'Office') {
    filterType = ['match', ['get', 'Type'], 'Office', true, false];
  } else if (type === 'Resi') {
    filterType = ['match', ['get', 'Type'], 'Resi', true, false];
  } else {
    console.log('error');
  };
  map.setFilter('residential-circles', ['all', filterYear, filterType]);
  map.setFilter('residential-labels', ['all', filterYear, filterType]);
});

function update(data) {
  updateHTML(data);
  // Update slider position when play button is looping
  $("#date-slider").slider("value", time);
}

let time = 1999;
let interval;

function step() {
  update(data[time]);
  time = (time == 2023) ? 0 : time + 1;
}

$("#date-slider").slider({
  max: 2023,
  min: 1999,
  step: 1,
  slide: (event, ui) => {
    time = ui.value;
    update(data[time]);
  }
});

function updateHTML(data) {
  // Update slider label
  $("#year-label").text(data.name);
  // Update table values
}
animateMarker(0);
console.log(data);
});
});
</script>

</body>
</html>
